#!/usr/bin/python

import cx_Oracle


def check_user_exists (mess, adduser,connection):
	query = 'select count(*) from dba_users where username = upper(\''+adduser+'\')'
	
	cursor = connection.cursor()
	
	try:
			cursor.execute(query)
			result = cursor.fetchall()[0][0]
	except cx_Oracle.DatabaseError, exc:
			error, = exc.args
			mess[0] = error.message+ 'sql: ' + query
			return False
			
	if result > 0:
		mess[0] = 'User '+adduser+' already exists'
		return True

def create_user (mess,adduser,connection):
	query = 'create user '+adduser+' identified by testuser'
	cursor = connection.cursor()
	try:
		cursor.execute(query)
	except cx_Oracle.DatabaseError, exc:
		error, = exc.args
		mess[0] = 'Blergh, something went wrong' + error.message
		return False
	return True
	


def main():

	mess = ['']
	module = AnsibleModule(
		argument_spec = dict(
			hostname      = dict(default='localhost'),
			user          = dict(required=True),
			passw         = dict(required=True),
			adduser       = dict(required=True)
		)
	)

	hostname = module.params["hostname"]
	user = module.params["user"]
	passw = module.params["passw"]
	adduser = module.params["adduser"]

	connection = cx_Oracle.Connection("system/Oracle123@localhost/orcl")
	if not check_user_exists(mess,adduser,connection):
		if create_user(mess,adduser,connection):
			mess[0] = 'The schema '+adduser+' created successfully'
			module.exit_json(msg=mess[0], changed=True)
		else:
			module.fail_json(msg=mess[0], changed=False)
	module.exit_json(msg=mess[0], changed=False)





from ansible.module_utils.basic import *
if __name__ == '__main__':
	main()
